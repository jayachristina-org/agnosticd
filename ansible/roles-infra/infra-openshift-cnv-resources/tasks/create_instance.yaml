---

- name: Create Instance "{{ _instance.name }}"
  register: r_openshift_cnv_instance
  kubevirt_vm:
      state: running
      name: "{{ _instance.name }}{{ _instance_index+1 if _instance.count|default(1)|int > 1 else '' }}"
      namespace: "{{ openshift_cnv_project_name }}"
      memory: "{{ _instance.memory }}"
      cpu_cores: "{{ _instance.cores }}"
      wait_timeout: 2400
      datavolumes:
        - name: "{{ _instance.name|replace('.','') }}{{ _instance_index+1 if _instance.count|default(1)|int > 1 else ''}}-{{ guid }}"
          source:
            pvc:
              namespace: "default"
              name: "{{ _instance.image }}"
          pvc:
            accessModes:
              - ReadWriteMany
            volumeMode: Block
            storage: "{{ _instance.image_size }}"
            name: "{{ _instance.image|replace('.','') }}{{ _instance_index+1 if _instance.count|default(1)|int > 1 else ''  }}-{{ guid }}"

      definition:
        metadata:
          annotations: >-
            {{ cloud_tags_final
            | combine(_instance.tags | ec2_tags_to_dict) }}
      cloud_init_nocloud: 
        userData: |-
          #cloud-config
          ssh_authorized_keys:
            - {{ lookup('file', openshift_cnv_ssh_pub_key_path ) }}
  loop: "{{ range(1, _instance.count|default(1)|int+1) | list }}"
  loop_control:
    index_var: _instance_index

- set_fact:
    r_openshift_cnv_instances: "{{ r_openshift_cnv_instances + [item] }}"
  loop: "{{ r_openshift_cnv_instance.results | list }}"
