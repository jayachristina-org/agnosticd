---
- name: Configure rbd as default storage
  shell: >
    oc patch storageclass ocs-storagecluster-ceph-rbd -p '{"metadata": {"annotations": {"storageclass.kubernetes.io/is-default-class": "true"}}}'

- name: Configure Image Registry with Ceph RGW
  block:
    - name: Create ObjectBucketClaim
      k8s:
        state: present
        definition:
          apiVersion: objectbucket.io/v1alpha1
          kind: ObjectBucketClaim
          metadata:
            name: rgwregistry
            namespace: openshift-storage
          spec:
            storageClassName: ocs-storagecluster-ceph-rgw
            generateBucketName: rgwregistry
      register: obc_result

    - name: Get Bucket Name
      shell: oc get obc -n openshift-storage rgwregistry -o jsonpath='{.spec.bucketName}'
      register: bucket_name

    - name: Get AWS_ACCESS_KEY_ID
      shell: oc get secret -n openshift-storage rgwregistry -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 --decode
      register: aws_access_key_id

    - name: Get AWS_SECRET_ACCESS_KEY
      shell: oc get secret -n openshift-storage rgwregistry -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 --decode
      register: aws_secret_access_key

    - name: Create Image Registry Secret
      shell: >
        oc create secret generic image-registry-private-configuration-user
        --from-literal=REGISTRY_STORAGE_S3_ACCESSKEY={{ aws_access_key_id.stdout }}
        --from-literal=REGISTRY_STORAGE_S3_SECRETKEY={{ aws_secret_access_key.stdout }}
        --namespace openshift-image-registry

    - name: Create Route Reencrypt
      shell: oc create route reencrypt s3route --service=rook-ceph-rgw-ocs-storagecluster-cephobjectstore --port=https -n openshift-storage

    - name: Get Route Host
      shell: oc get route s3route -n openshift-storage -o jsonpath='{.spec.host}'
      register: route_host

    - name: Create Image Registry S3 Bundle ConfigMap
      shell: oc create configmap image-registry-s3-bundle --from-file=ca-bundle.crt=/home/cloud-user/certificates/fullchain.pem  -n openshift-config

    - name: Patch Image Registry Config
      shell: oc patch config.image/cluster -p '{"spec":{"managementState":"Managed","replicas":2,"storage":{"managementState":"Unmanaged","s3":{"bucket":"{{ bucket_name.stdout }}","region":"us-east-1","regionEndpoint":"https://{{ route_host.stdout }}","virtualHostedStyle":false,"encrypt":false,"trustedCA":{"name":"image-registry-s3-bundle"}}}}}' --type=merge
